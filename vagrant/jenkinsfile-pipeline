pipeline {
    agent { label "jenkins-agent" }

    // tools {
    //     terraform 'terraform'
    // }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timestamps()
        ansiColor('xtrem')
    }

    environment {
        KIND_HOME = tool name: 'kind', type: 'com.cloudbees.jenkins.plugins.customtools.CustomTool'
        KUBECTL_HOME = tool name: 'kubectl', type: 'com.cloudbees.jenkins.plugins.customtools.CustomTool'
        PATH = "${KIND_HOME}:${KUBECTL_HOME}:${env.PATH}"
        DOCKER_HOST = 'kind'
        KIND_FOLDER = 'dip_project/vagrant'
        KUBECONFIG = '/var/jenkins_home/.kube/config'
    }

    stages {

        stage('Create kind cluster') {
            steps {
                dir(KIND_FOLDER) {
                    sh """
                    export DOCKER_HOST = "tcp://{$DOCKER_HOST}"
                    export DOCKER_HOST_IP = {$DOCKER_HOST}
                    export KUBECONFIG = ${KUBECONFIG}
                    bash kind-install.sh
                    """
                }
            }
        }
    }
}